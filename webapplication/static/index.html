<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Decision - ATLANE</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/fuzzy-bubbles.css" rel="stylesheet">
    <script src="/static/js/socket.io.min.js"></script>
    <script src="/static/js/jquery.min.js"></script>
    <style>
        HTML,
        BODY {
            background: url("/static/background.png") no-repeat center center fixed;
            background-size: cover;
            height: 100%;
            width: 100%;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            /* required to prevent rogue scrollbars */
            overflow: hidden;
            /* cosmetic stuff: */
            background-color: black;
        }

        .responsive-div {
            margin-left: 2.5vw;
            margin-top: 5vw;
            display: flex;
            flex-direction: column;
            height: 85vh;
            width: 90vw;
            background-color: rgba(248, 249, 250, 0.8);
            box-sizing: border-box;
            border-radius: 1em;
            overflow: hidden;
            /* Prevent any overflow beyond this point */
        }

        .chat-messages {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            /* Allow this element to scroll */
            padding: 10px;
        }

        .message {
            background-color: #f0f0f0;
            padding: 10px 20px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 90%;
        }

        .sent {
            align-self: flex-start;
            background-color: #DCF8C6;
            position: relative;
        }

        .received {
            font-family: "Fuzzy Bubbles", sans-serif;
            font-weight: 700;
            font-size: 1.5em;
            align-self: flex-end;
            right: 5vw;
            background-color: #f0f0f0;
        }

        #chartsContainerAnswer * {
            max-width: 100%;
            height: auto;
        }

        #chartsContainerAnswer iframe,
        #chartsContainerAnswer embed,
        #chartsContainerAnswer object {
            max-width: 45%;
            height: auto;
        }
    </style>
</head>

<body>
    <div class="container d-flex" style="height: 100vh;">
        <div class="responsive-div">
            <div class="text-center p-3" style="border-bottom: lightgray;">
                <span class="h3">Request a Decision from the Universe: </span><br>
                <span class="h5">Powered by a Gamma-Event True Random Number Generator</span>
            </div>

            <div id="messages" class="chat-messages d-flex flex-grow-1"></div>
            <div id="chartsContainer" class="d-flex flex-grow-1" style="visibility: hidden;"></div>

            <!-- Input -->
            <div class="text-center p-3">
                <small><b>Please keep in mind: messages will be stored visible to everyone! Do not enter any sensitive, secret, harmfull or disrespectful Information!</b></small>
                <input type="text" id="chatInput" class="form-control" rows="3" maxlength="1000" placeholder="Your Question">
                <div class="d-flex justify-content-center gap-2 mt-3">
                    <button class="btn btn-primary" onclick="sendMessage()">Ask the univers for a "Yeah!" or
                        "Nope..."</button>
                    <button class="btn btn-secondary" onclick="runNistTests()">NIST Randomness Tests</button>
                </div>
            </div>
            <div class="p-1 text-center">
                <a class="link-opacity-100" href="https://atlane.de/impressum/" target="_blank">Impressum</a>
                <a class="link-opacity-100" href="https://atlane.de/datenschutzbestimmungen/" target="_blank">Datenschutz</a>
                <br>
                <small class="text-muted">Last Ping: <span id="lastPingTime">Loading...</span></small>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="rateLimitModal" tabindex="-1" aria-labelledby="rateLimitModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rateLimitModalLabel">Message Sending Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="error-message"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="rateLimitModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rateLimitModalLabel">Question added to RandomAnswer Queue</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Your message was added to the RandomAnswer Queue. Please wait until the Univers sends an
                    answer to your question: </br>
                    <div id="messages-dialog" class="mb-3 chat-messages"></div>
                    Needed 4 Gamma-Events:
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                    </div>

                    <div id="chartsContainerAnswer"></div>
                    <!-- Container for new charts after question -->
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <!-- NIST Tests Modal -->
    <div class="modal fade" id="nistTestsModal" tabindex="-1" aria-labelledby="nistTestsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nistTestsModalLabel">NIST Randomness Test Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="nist-loading" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Running NIST randomness tests...</p>
                        </div>
                    </div>
                    <div id="nist-results">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();


        var awaiting_answer = false;
        var awaiting_answer_gamma_events = 0;
        var awaiting_answer_message_id = 0;

        document.addEventListener('DOMContentLoaded', function () {

            socket.on('message_error', function (data) {
                // Show error modal for rate limit or other errors
                var rateLimitModalElement = document.getElementById('rateLimitModal');
                var rateLimitModalInstance = new bootstrap.Modal(rateLimitModalElement);

                console.log(data);

                const errormessagediv = document.getElementById('error-message');
                errormessagediv.textContent = data.error;

                rateLimitModalInstance.show();
            });
            socket.on('message_added', function (data) {
                awaiting_answer = true;
                awaiting_answer_gamma_events = 0;
                awaiting_answer_message_id = data.id;

                const progressBar = document.querySelector('.progress-bar');
                const maxValue = parseInt(progressBar.style.width); // Get the maximum value from the width style
                progressBar.setAttribute('aria-valuenow', 0);
                progressBar.style.width = 0 + '%';
                document.getElementById('chartsContainerAnswer').replaceChildren();
                var modalElement = document.getElementById('sendMessageModal');
                var modalInstance = new bootstrap.Modal(modalElement);

                const messagesContainerDialgo = document.getElementById('messages-dialog');

                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                messageDiv.classList.add('sent');
                messageDiv.textContent = data.message + " (" + data.timestamp + ") - " + data.username;
                messagesContainerDialgo.replaceChildren();
                messagesContainerDialgo.appendChild(messageDiv); // This appends the message at the end.
                modalInstance.show();
            });
        });

        function createChart(timestamp, data, plot_image, question_dialog = false) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container my-4 p-3 shadow-sm border';

            const title = document.createElement('h5');
            title.textContent = `Event: ${timestamp}`;
            chartContainer.appendChild(title);

            const image = document.createElement('img')
            image.src = `data:image/jpeg;base64,${plot_image}`;
            image.style = "background-color: transparent; max-height: 25vw"

            chartContainer.appendChild(image);

            //document.getElementById('chartsContainer').appendChild(chartContainer);
            if (question_dialog) {
                document.getElementById('chartsContainerAnswer').appendChild(chartContainer);
            }
        }

        socket.on('initial_data', function (entries) {
            entries.forEach(entry => {
                createChart(entry.timestamp, entry.data.data, entry.image_plot);
            });
        });

        socket.on('new_data', function (entry) {

            if (awaiting_answer == false) {

            } else {

                const progressBar = document.querySelector('.progress-bar');
                const maxValue = parseInt(progressBar.style.width); // Get the maximum value from the width style

                if (awaiting_answer_gamma_events < 4) {
                    createChart(entry.timestamp, entry.data.data, entry.image_plot, question_dialog = true);

                    awaiting_answer_gamma_events += 1;

                    let currentValue = parseInt(progressBar.getAttribute('aria-valuenow')); // Current value starts at 0

                    currentValue += 25; // Increment the current value
                    progressBar.setAttribute('aria-valuenow', currentValue);
                    progressBar.textContent = awaiting_answer_gamma_events + "/4";
                    progressBar.style.width = currentValue + '%';
                } else {
                    awaiting_answer = false;
                }

            }

        });

        function sendMessage() {
            const message = document.getElementById('chatInput').value;
            socket.emit('send_message', message);
            document.getElementById('chatInput').value = '';
        }

        function loadInitialMessages() {
            $.get('/latest_messages', function (messages) {
                messages.forEach(msg => displayMessage(msg));
            });
        }

        loadInitialMessages();

        function displayMessage(msg) {
            console.log("Display Message called");
            console.log(msg);
            const messagesContainer = document.getElementById('messages');

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add('sent');

            messageDiv.innerHTML = msg.message + " </br><em><small style='color:gray,'> (" + msg.timestamp + ") - " + msg.username + "</small></em>";

            const answerDiv = document.createElement('div');
            answerDiv.classList.add('message');
            answerDiv.classList.add('received');
            answerDiv.textContent = msg.answer;

            const image = document.createElement('img')
            image.src = `data:image/jpeg;base64,${msg.answer_image_plot}`;
            image.style = "background-color: transparent; max-width: 10vw; padding-top:10px"
            answerDiv.appendChild(document.createElement('br'));
            answerDiv.appendChild(image);

            messagesContainer.appendChild(messageDiv); // This appends the message at the end.
            messagesContainer.appendChild(answerDiv); // This appends the message at the end.

            messagesContainer.scrollTop = messagesContainer.scrollHeight + 300;

            let answerDiv2 = answerDiv;
            let messageDiv2 = messageDiv;

            if (msg.id == awaiting_answer_message_id) {
                const messagesContainerDialog = document.getElementById('messages-dialog');
                messagesContainerDialog.replaceChildren();

                const messageDiv2 = document.createElement('div');
                messageDiv2.classList.add('message');
                messageDiv2.classList.add('sent');

                messageDiv2.innerHTML = msg.message + " </br><em><small style='color:gray,'> (" + msg.timestamp + ") - " + msg.username + "</small></em>";

                const answerDiv2 = document.createElement('div');
                answerDiv2.classList.add('message');
                answerDiv2.classList.add('received');
                answerDiv2.textContent = msg.answer;

                const image = document.createElement('img')
                image.src = `data:image/jpeg;base64,${msg.answer_image_plot}`;
                image.style = "background-color: transparent; max-width: 10vw; padding-top:10px"
                answerDiv2.appendChild(document.createElement('br'));
                answerDiv2.appendChild(image);

                messagesContainerDialog.appendChild(messageDiv2);
                messagesContainerDialog.appendChild(answerDiv2);
            }
        }


        socket.on('receive_message', function (msg) {
            displayMessage(msg);
        });

        let lastLoadedMessageId;

        window.addEventListener('scroll', function () {
            if (window.scrollY === 0) {  // User has scrolled to the top of the window
                loadOlderMessages();
            }
        });

        function loadOlderMessages() {
            if (lastLoadedMessageId) {
                $.get(`/older_messages?last_id=${lastLoadedMessageId}`, function (messages) {
                    if (messages.length > 0) {
                        messages.forEach(msg => {
                            const messageDiv = document.createElement('div');
                            messageDiv.textContent = msg.message + " (" + msg.timestamp + ") - " + msg.username;
                            const messagesContainer = document.getElementById('messages');
                            messagesContainer.insertBefore(messageDiv, messagesContainer.firstChild);
                            lastLoadedMessageId = messages[messages.length - 1].id;
                        });
                    }
                });
            }
        }

        function runNistTests() {
            const modal = new bootstrap.Modal(document.getElementById('nistTestsModal'));
            const loadingDiv = document.getElementById('nist-loading');
            const resultsDiv = document.getElementById('nist-results');
            
            // Show modal and loading state
            modal.show();
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            // Make AJAX request to run NIST tests
            $.ajax({
                url: '/nist_tests',
                method: 'GET',
                timeout: 30000, // 30 second timeout
                success: function(response) {
                    loadingDiv.style.display = 'none';
                    displayNistResults(response);
                },
                error: function(xhr, status, error) {
                    loadingDiv.style.display = 'none';
                    let errorMessage = 'Error running NIST tests';
                    
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (status === 'timeout') {
                        errorMessage = 'Request timed out - tests may take longer than expected';
                    }
                    
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>Error</h6>
                            <p>${errorMessage}</p>
                        </div>
                    `;
                }
            });
        }

        function displayNistResults(response) {
            const resultsDiv = document.getElementById('nist-results');
            
            let html = '';
            
            // Always show file statistics if available
            if (response.file_stats) {
                const stats = response.file_stats;
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Random Bits File Statistics</h6>
                        </div>
                        <div class="card-body">
                `;
                
                if (stats.file_exists) {
                    html += `
                            <div class="row">
                                <div class="col-sm-6">
                                    <strong>Total Bits:</strong> ${stats.bit_count.toLocaleString()}
                                </div>
                                <div class="col-sm-6">
                                    <strong>File Size:</strong> ${stats.file_size_bytes} bytes
                                </div>
                                <div class="col-sm-6">
                                    <strong>Ones (1):</strong> ${stats.ones_count.toLocaleString()} (${stats.ones_percentage}%)
                                </div>
                                <div class="col-sm-6">
                                    <strong>Zeros (0):</strong> ${stats.zeros_count.toLocaleString()} (${stats.zeros_percentage}%)
                                </div>
                                <div class="col-sm-12 mt-2">
                                    <strong>Sufficient for NIST Tests:</strong> 
                                    <span class="badge ${stats.is_sufficient_for_nist ? 'bg-success' : 'bg-warning'}">
                                        ${stats.is_sufficient_for_nist ? 'Yes' : 'No (need â‰¥1000 bits)'}
                                    </span>
                                </div>
                            </div>
                    `;
                } else {
                    html += `
                            <div class="alert alert-warning mb-0">
                                <strong>File Issue:</strong> ${stats.error || 'Random bits file not found'}
                            </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            if (response.status === 'success') {
                const summary = response.summary;
                const results = response.results;
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Test Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-6">
                                    <strong>Total Tests:</strong> ${summary.total_tests}
                                </div>
                                <div class="col-sm-6">
                                    <strong>Passed Tests:</strong> ${summary.passed_tests}
                                </div>
                                <div class="col-sm-6">
                                    <strong>Success Rate:</strong> ${(summary.success_rate * 100).toFixed(1)}%
                                </div>
                                <div class="col-sm-6">
                                    <strong>Overall Result:</strong> 
                                    <span class="badge ${summary.overall_result === 'PASS' ? 'bg-success' : 'bg-danger'}">
                                        ${summary.overall_result}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Individual Test Results</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Status</th>
                                            <th>P-Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                for (const [testName, result] of Object.entries(results)) {
                    const statusBadge = result.passed ? 
                        '<span class="badge bg-success">PASS</span>' : 
                        '<span class="badge bg-danger">FAIL</span>';
                    
                    html += `
                        <tr>
                            <td>${testName}</td>
                            <td>${statusBadge}</td>
                            <td>${result.p_value}</td>
                        </tr>
                    `;
                }
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <h6>Test Results</h6>
                        <p>${response.message}</p>
                    </div>
                `;
                resultsDiv.innerHTML = html;
            }
        }

        // Function to fetch and update last ping timestamp
        function updateLastPingTime() {
            $.ajax({
                url: '/getlastping',
                method: 'GET',
                success: function(response) {
                    document.getElementById('lastPingTime').textContent = response.last_ping;
                },
                error: function(xhr, status, error) {
                    document.getElementById('lastPingTime').textContent = 'Error loading ping time';
                }
            });
        }

        // Update ping time immediately and then every 10 seconds
        updateLastPingTime();
        setInterval(updateLastPingTime, 10000);
    </script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
</body>

</html>